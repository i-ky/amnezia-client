app-id: org.amnezia.AmneziaVPN
runtime: org.kde.Platform
runtime-version: '6.4'
sdk: org.kde.Sdk
command: AmneziaVPN
rename-desktop-file: AmneziaVPN.desktop
finish-args:
- --share=network
- --share=ipc
- --socket=x11
- --socket=wayland
- --device=dri
modules:
- name: app
  sources:
  - type: dir
    path: ./
    skip:
    - deploy/AppDir/
    - deploy/Tools/
    - deploy/build/
    - deploy/AmneziaVPN_Linux_Installer
  - type: archive
    url: https://github.com/QuasarApp/CQtDeployer/releases/download/v1.5.4.17/CQtDeployer_1.5.4.17_Linux_x86_64.zip
    md5: 13ef4246e5b1fc0a32e9bcafed7573a1
    strip-components: 0
    dest: deploy/Tools/cqtdeployer
  - type: shell
    commands:
    - chmod +x -R deploy/Tools/cqtdeployer
  - type: archive
    url: https://www.7-zip.org/a/7z2201-linux-x64.tar.xz
    sha256: 2c266f6794adec310c4631232c1d039f46988d51082fe5e80349c52ee7ed60bb
    dest: deploy/Tools/7zip
    strip-components: 0
  buildsystem: simple
  build-commands:
  - >-
    set -o errexit -o nounset &&
    export PROJECT_DIR=$(pwd) &&
    export DEPLOY_DIR=$PROJECT_DIR/deploy &&
    mkdir -p $DEPLOY_DIR/build &&
    export BUILD_DIR=$DEPLOY_DIR/build &&
    qt-cmake --version &&
    gcc -v &&
    cd $BUILD_DIR &&
    qt-cmake -DOPENSSL_ROOT_DIR=$FLATPAK_DEST -S $PROJECT_DIR &&
    cmake --build . --config release -- -j$FLATPAK_BUILDER_N_JOBS &&
    export DEPLOY_DATA_DIR=$PROJECT_DIR/deploy/data/linux &&
    export APP_DIR=$DEPLOY_DIR/AppDir &&
    mkdir -p $APP_DIR &&
    cp -r $DEPLOY_DATA_DIR/* $APP_DIR &&
    export TOOLS_DIR=$DEPLOY_DIR/Tools &&
    mkdir -p $TOOLS_DIR &&
    export CQTDEPLOYER_DIR=$TOOLS_DIR/cqtdeployer &&
    $CQTDEPLOYER_DIR/cqtdeployer.sh -bin $BUILD_DIR/client/AmneziaVPN -qmake qmake -qmlDir $PROJECT_DIR/client/ui/qml/ -targetDir $APP_DIR/client/ &&
    $CQTDEPLOYER_DIR/cqtdeployer.sh -bin $BUILD_DIR/service/server/AmneziaVPN-service -qmake qmake -targetDir $APP_DIR/service/ &&
    export APP_DOMAIN=org.amneziavpn.package &&
    export INSTALLER_DATA_DIR=$PROJECT_DIR/deploy/installer/packages/$APP_DOMAIN/data &&
    $TOOLS_DIR/7zip/7zz a $INSTALLER_DATA_DIR/data.7z $APP_DIR/* &&
    cp -r $PROJECT_DIR/deploy/installer $BUILD_DIR &&
    $CQTDEPLOYER_DIR/binarycreator.sh --offline-only -v -c $BUILD_DIR/installer/config/linux.xml -p $BUILD_DIR/installer/packages -f $PROJECT_DIR/deploy/AmneziaVPN_Linux_Installer &&
    $DEPLOY_DIR/AmneziaVPN_Linux_Installer install --root $FLATPAK_DEST/AmneziaVPN/ --confirm-command --accept-messages --accept-licenses
  modules:
  - name: OpenSSL
    sources:
    - type: archive
      url: https://github.com/openssl/openssl/releases/download/openssl-3.1.0/openssl-3.1.0.tar.gz
      sha256: aaa925ad9828745c4cad9d9efeb273deca820f2cdcf2c3ac7d7c1212b7c497b4
    buildsystem: simple
    build-commands:
    - ./config --prefix=$FLATPAK_DEST
    - make -j$FLATPAK_BUILDER_N_JOBS
    # - make test
    - make install
  - name: libsecret
    sources:
    - type: git
      url: https://gitlab.gnome.org/GNOME/libsecret.git
      tag: '0.20.5'
    buildsystem: simple
    build-commands:
    - meson _build -Dgtk_doc=false -Dprefix=$FLATPAK_DEST
    - ninja -C _build
    - ninja -C _build install
    modules:
    - name: Vala
      sources:
      - type: archive
        url: https://download.gnome.org/sources/vala/0.56/vala-0.56.7.tar.xz
        sha256: 3d39c7596d5fa9ae8bfeae476669f811f7057b7f7b9308478a27b68443d8b003
      buildsystem: simple
      build-commands:
      - ./configure --prefix=$FLATPAK_DEST
      - make -j$FLATPAK_BUILDER_N_JOBS
      - make install
      modules:
      - name: graphviz
        sources:
        - type: archive
          url: https://gitlab.com/api/v4/projects/4207231/packages/generic/graphviz-releases/8.0.5/graphviz-8.0.5.tar.gz
          sha256: bfe1a7a68613875ca086b8c7d4890ca7e2a9ce5d125c0a0c0e95e8a66df5d0ef
        buildsystem: simple
        build-commands:
        - ./configure --prefix=$FLATPAK_DEST
        - make -j$FLATPAK_BUILDER_N_JOBS
        - make install
  - name: Kerberos
    sources:
    - type: archive
      url: http://web.mit.edu/kerberos/dist/krb5/1.20/krb5-1.20.1.tar.gz
      sha256: 704aed49b19eb5a7178b34b2873620ec299db08752d6a8574f95d41879ab8851
    subdir: src
    buildsystem: simple
    build-commands:
    - ./configure --prefix=$FLATPAK_DEST
    - make -j$FLATPAK_BUILDER_N_JOBS
    - make install
